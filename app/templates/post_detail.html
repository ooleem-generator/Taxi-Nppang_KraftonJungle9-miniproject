{% extends 'base.html' %}

{% block title %}ëª¨ì§‘ê¸€ ìƒì„¸{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">

    <!-- ìƒë‹¨ ë’¤ë¡œê°€ê¸° + ë“±ë¡ì¼ -->
    <div class="flex justify-between items-center text-xs text-gray-400 mb-4">
    <!-- ë’¤ë¡œê°€ê¸° -->
    <a href="/" class="text-sm text-blue-600 hover:underline flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
        </svg>
        ëŒì•„ê°€ê¸°
    </a>

    <!-- ë“±ë¡ì¼ -->
    <span>ë“±ë¡ì¼: {{ post.created_at }}</span>
    </div>

    <!-- ì¶œë°œì§€ / ë„ì°©ì§€ -->
    <div class="text-center mt-10 mb-6">
        <div class="flex justify-center items-center gap-6">
        <!-- ì¶œë°œì§€ -->
        <div>
            <div class="text-sm text-gray-500">ì¶œë°œì§€</div>
            <div class="text-xl font-bold text-gray-800">{{ post.departure }}</div>
            <div class="text-xs text-gray-500">{{ post.departureDetail }}</div>
        </div>

        <!-- í™”ì‚´í‘œ -->
        <div class="pt-6 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </div>

        <!-- ë„ì°©ì§€ -->
        <div>
            <div class="text-sm text-gray-500">ë„ì°©ì§€</div>
            <div class="text-xl font-bold text-gray-800">{{ post.destination }}</div>
            <div class="text-xs text-gray-500">{{ post.destinationDetail }}</div>
        </div>
        </div>
    </div>

    <div class="text-center mb-6">
        <!-- ì¶œë°œ ì‹œê°„ -->
        <div class="text-m text-gray-700 font-bold mb-3">
            ğŸ•“ {{ post.departure_time }}
        </div>

        <!-- ì¸ì› ìˆ˜ -->
        <div class="text-sm text-gray-700 mb-4">
            ğŸ‘¥ ì¸ì›: {{ post.currentMembers }} / {{ post.totalMembers }}
            {% if post.currentMembers >= post.totalMembers %}
                <span class="ml-2 text-red-500 font-semibold">[ëª¨ì§‘ ë§ˆê°]</span>
            {% endif %}
        </div>
    </div>

    <!-- ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ (ìë¦¬ ê³ ì •) -->
    <div class="flex flex-wrap justify-center gap-2 mb-6">
        {% for participant in participants %}
            <div class="px-3 py-1 rounded border flex items-center gap-1 min-w-[100px]
                        {% if participant.is_me %} bg-blue-100 border-blue-400 {% else %} bg-gray-100 border-gray-300 {% endif %}">
                {% if participant.is_host %}
                    <span class="text-yellow-500">ğŸ‘‘</span>
                {% endif %}
                <span class="font-semibold text-gray-800">{{ participant.userName }}</span>
            </div>
        {% endfor %}

        {% set remaining_slots = post.totalMembers - participants|length %}
        {% for _ in range(remaining_slots) %}
            <div class="px-3 py-1 bg-white text-gray-400 border border-dashed border-gray-300 rounded min-w-[100px] text-center">
                ì°¸ì—¬ ê°€ëŠ¥
            </div>
        {% endfor %}
    </div>

    <!-- ì§€ë„ ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="flex justify-center mb-6">
        <div class="w-64 h-64 bg-gray-200 rounded overflow-hidden">
        <!-- <img src="/static/images/route.png" alt="ê²½ë¡œ ì´ë¯¸ì§€" class="object-cover w-full h-full" /> -->
        </div>
    </div>

    <!-- ì„¤ëª… -->
    <div class="mt-6">
        <h4 class="font-semibold mb-2">ì„¤ëª…</h4>
        <div class="bg-gray-100 p-3 rounded text-sm text-gray-700 whitespace-pre-wrap">
        {{ post.postContent }}
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì‘ì„± -->
    <div class="mt-10">
        <h4 class="font-semibold mb-2">ëŒ“ê¸€</h4>

        {% if session.get("user") %}
        <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ ì…ë ¥ ê°€ëŠ¥ -->
        <form action="/comments" method="POST" class="flex gap-2 mb-4">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <input type="text" name="comment" class="flex-1 border border-gray-300 p-2 rounded" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            <button type="submit" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">ë“±ë¡</button>
        </form>
        {% else %}
        <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì•ˆë‚´ -->
        <p class="text-red-500 text-sm mb-4">â€» ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        {% endif %}

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="space-y-2 text-sm">
            {% for comment in comments %}
            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                <strong class="text-gray-800">{{ comment.author }}</strong>
                <span class="text-gray-500 ml-2">{{ comment.createdAt }}</span>
                <p class="mt-1 text-gray-700">{{ comment.commentContent }}</p>
            </div>
            {% endfor %}
        </div>
  </div>

    <!-- ì°¸ì—¬ / ì·¨ì†Œ ë²„íŠ¼ -->
    <div class="flex justify-end gap-4 mt-10">
        {% if not is_author %}
            {% if is_participating %}
            <!-- ì°¸ì—¬ ì·¨ì†Œ ë²„íŠ¼ -->
            <form onsubmit="return cancelParticipation(event, '{{ post.id }}')">
                <button type="submit" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
                ì°¸ì—¬ ì·¨ì†Œ
                </button>
            </form>
            {% else %}
            <!-- ì°¸ì—¬ ë²„íŠ¼ -->
            <form action="/posts/{{ post.id }}/participate" method="POST">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                ì°¸ì—¬í•˜ê¸°
                </button>
            </form>
            {% endif %}
        {% endif %}
        {% if is_author %}
            <form action="/posts/{{ post.id }}/delete" method="POST" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    ê¸€ ì‚­ì œí•˜ê¸°
                </button>
            </form>
        {% endif %}
    </div>
</div>

<script>
  function cancelParticipation(event, postId) {
    event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë§‰ê¸°

    fetch(`/posts/${postId}/participate`, {
      method: "DELETE"
    })
    .then(res => {
      if (res.redirected) {
        window.location.href = res.url;
      } else {
        location.reload(); // ì‹¤íŒ¨í•´ë„ ìƒˆë¡œê³ ì¹¨
      }
    });
  }
</script>
{% endblock %}