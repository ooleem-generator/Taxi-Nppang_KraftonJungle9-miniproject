{% extends 'base.html' %}

{% block title %}ëª¨ì§‘ê¸€ ìƒì„¸{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">

    <!-- ìƒë‹¨ ë’¤ë¡œê°€ê¸° + ë“±ë¡ì¼ -->
    <div class="flex justify-between items-center text-xs text-gray-400 mb-4">
    <!-- ë’¤ë¡œê°€ê¸° -->
    <a href="/" class="text-sm text-blue-600 hover:underline flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
        </svg>
        ëŒì•„ê°€ê¸°
    </a>

    <!-- ë“±ë¡ì¼ -->
    <span>ë“±ë¡ì¼: {{ formatted_created }}</span>
    </div>

    <!-- ì¶œë°œì§€ / ë„ì°©ì§€ -->
    <div class="text-center mt-10 mb-6">
        <div class="flex justify-center items-center gap-6">
        <!-- ì¶œë°œì§€ -->
        <div>
            <div class="text-sm text-gray-500">ì¶œë°œì§€</div>
            <div class="text-xl font-bold text-gray-800">{{ post.departure }}</div>
            <div class="text-xs text-gray-500">{{ post.departureDetail }}</div>
        </div>

        <!-- í™”ì‚´í‘œ -->
        <div class="pt-6 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </div>

        <!-- ë„ì°©ì§€ -->
        <div>
            <div class="text-sm text-gray-500">ë„ì°©ì§€</div>
            <div class="text-xl font-bold text-gray-800">{{ post.destination }}</div>
            <div class="text-xs text-gray-500">{{ post.destinationDetail }}</div>
        </div>
        </div>
    </div>

    <div class="text-center mb-6">
        <!-- ì¶œë°œ ì‹œê°„ -->
        <div class="text-m text-gray-700 font-bold mb-3">
            ğŸ•“ {{ formatted_departure }}
        </div>

        <!-- ì¸ì› ìˆ˜ -->
        <div class="text-sm text-gray-700 mb-4">
            ğŸ‘¥ ì¸ì›: {{ post.currentMembers }} / {{ post.totalMembers }}
        </div>
    </div>

    <!-- ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ (ìë¦¬ ê³ ì •) -->
    <div class="flex flex-wrap justify-center gap-2 mb-6">
        {% set filled = participations | length %}
        {% set total = post.totalMembers %}

        {% for i in range(total) %}
            {% if i < filled %}
                {% set participant = participations[i] %}
                {% set is_host = participant.userId == post.authorId %}
                {% set is_me = participant.userId == current_user_id %}

                <div class="px-3 py-1 bg-gray-100 rounded border border-gray-300 flex items-center gap-1 min-w-[100px]">
                    {% if is_host %}<span>ğŸ‘‘</span>{% endif %}
                    <span class="text-gray-800 font-semibold">
                    {{ participant.userName }}
                    {% if is_me %}<span class="text-blue-600">(ë‚˜)</span>{% endif %}
                    </span>
                    {% if is_host %}
                    <span class="text-xs text-gray-500 ml-1">(í˜¸ìŠ¤íŠ¸)</span>
                    {% endif %}
                </div>
            {% else %}
                <div class="px-3 py-1 bg-white text-gray-400 border border-dashed border-gray-300 rounded min-w-[100px] text-center">
                    ì°¸ì—¬ ê°€ëŠ¥
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- ì§€ë„ ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="flex justify-center mb-6">
        <div class="w-64 h-64 bg-gray-200 rounded overflow-hidden">
        <!-- <img src="/static/images/route.png" alt="ê²½ë¡œ ì´ë¯¸ì§€" class="object-cover w-full h-full" /> -->
        </div>
    </div>

    <!-- ì„¤ëª… -->
    <div class="mt-6">
        <h4 class="font-semibold mb-2">ì„¤ëª…</h4>
        <div class="bg-gray-100 p-3 rounded text-sm text-gray-700 whitespace-pre-wrap">
        {{ post.postContent }}
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì‘ì„± -->
    <div class="mt-10">
        <h4 class="font-semibold mb-2">ëŒ“ê¸€</h4>

        {% if session.get("user") %}
        <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ ì…ë ¥ ê°€ëŠ¥ -->
        <form action="/comments" method="POST" class="flex gap-2 mb-4">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <input type="text" name="comment" class="flex-1 border border-gray-300 p-2 rounded" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            <button type="submit" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">ë“±ë¡</button>
        </form>
        {% else %}
        <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì•ˆë‚´ -->
        <p class="text-red-500 text-sm mb-4">â€» ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        {% endif %}

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="space-y-2 text-sm">
            {% for comment in comments %}
            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                <strong class="text-gray-800">{{ comment.authorName }}</strong>
                <span class="text-gray-500 ml-2">{{ comment.createdAt.strftime('%Y-%m-%d %H:%M') }}</span>
                <p class="mt-1 text-gray-700">{{ comment.commentContent }}</p>
            </div>
            {% endfor %}
        </div>
  </div>

    <!-- ì°¸ì—¬ / ì·¨ì†Œ ë²„íŠ¼ -->
    <div class="flex justify-end gap-4 mt-10">
        {% if is_participating %}
        <!-- ì·¨ì†Œ: DELETE ìš”ì²­ì„ JSë¡œ ì²˜ë¦¬ -->
        <form id="cancel-form" action="/posts/{{ post._id }}/participate" method="POST"
        onsubmit="return cancelParticipation(event)">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <button type="submit" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">ì·¨ì†Œí•˜ê¸°</button>
        </form>
        {% else %}
        <!-- ì°¸ì—¬: POST -->
        <form action="/posts/{{ post._id }}/participate" method="POST">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ì°¸ì—¬í•˜ê¸°</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
    async function cancelParticipation(event) {
        event.preventDefault();

        const form = event.target.closest("form");
        fetch(form.action, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(new FormData(form))
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                location.reload();
            }
        });

        return false;
    }
</script>
{% endblock %}