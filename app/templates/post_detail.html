{% extends 'base.html' %}

{% block title %}모집글 상세{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">

    <!-- 상단 뒤로가기 + 등록일 -->
    <div class="flex justify-between items-center text-xs text-gray-400 mb-4">
    <!-- 뒤로가기 -->
    <a href="/" class="text-sm text-blue-600 hover:underline flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
        </svg>
        돌아가기
    </a>

    <!-- 등록일 -->
    <span>등록일: {{ formatted_created }}</span>
    </div>

    <!-- 출발지 / 도착지 -->
    <div class="text-center mt-10 mb-6">
        <div class="flex justify-center items-center gap-6">
        <!-- 출발지 -->
        <div>
            <div class="text-sm text-gray-500">출발지</div>
            <div class="text-xl font-bold text-gray-800">{{ post.departure }}</div>
            <div class="text-xs text-gray-500">{{ post.departureDetail }}</div>
        </div>

        <!-- 화살표 -->
        <div class="pt-6 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </div>

        <!-- 도착지 -->
        <div>
            <div class="text-sm text-gray-500">도착지</div>
            <div class="text-xl font-bold text-gray-800">{{ post.destination }}</div>
            <div class="text-xs text-gray-500">{{ post.destinationDetail }}</div>
        </div>
        </div>
    </div>

    <div class="text-center mb-6">
        <!-- 출발 시간 -->
        <div class="text-m text-gray-700 font-bold mb-3">
            🕓 {{ formatted_departure }}
        </div>

        <!-- 인원 수 -->
        <div class="text-sm text-gray-700 mb-4">
            👥 인원: {{ post.currentMembers }} / {{ post.totalMembers }}
        </div>
    </div>

    <!-- 참여자 리스트 (자리 고정) -->
    <div class="flex flex-wrap justify-center gap-2 mb-6">
        {% set filled = participations | length %}
        {% set total = post.totalMembers %}

        {% for i in range(total) %}
            {% if i < filled %}
                {% set participant = participations[i] %}
                {% set is_host = participant.userId == post.authorId %}
                {% set is_me = participant.userId == current_user_id %}

                <div class="px-3 py-1 bg-gray-100 rounded border border-gray-300 flex items-center gap-1 min-w-[100px]">
                    {% if is_host %}<span>👑</span>{% endif %}
                    <span class="text-gray-800 font-semibold">
                    {{ participant.userName }}
                    {% if is_me %}<span class="text-blue-600">(나)</span>{% endif %}
                    </span>
                    {% if is_host %}
                    <span class="text-xs text-gray-500 ml-1">(호스트)</span>
                    {% endif %}
                </div>
            {% else %}
                <div class="px-3 py-1 bg-white text-gray-400 border border-dashed border-gray-300 rounded min-w-[100px] text-center">
                    참여 가능
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- 지도 이미지 영역 -->
    <div class="flex justify-center mb-6">
        <div class="w-64 h-64 bg-gray-200 rounded overflow-hidden">
        <!-- <img src="/static/images/route.png" alt="경로 이미지" class="object-cover w-full h-full" /> -->
        </div>
    </div>

    <!-- 설명 -->
    <div class="mt-6">
        <h4 class="font-semibold mb-2">설명</h4>
        <div class="bg-gray-100 p-3 rounded text-sm text-gray-700 whitespace-pre-wrap">
        {{ post.postContent }}
        </div>
    </div>

    <!-- 댓글 작성 -->
    <div class="mt-10">
        <h4 class="font-semibold mb-2">댓글</h4>

        {% if session.get("user") %}
        <!-- 로그인한 사용자만 댓글 입력 가능 -->
        <form action="/comments" method="POST" class="flex gap-2 mb-4">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <input type="text" name="comment" class="flex-1 border border-gray-300 p-2 rounded" placeholder="댓글을 입력하세요" required>
            <button type="submit" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">등록</button>
        </form>
        {% else %}
        <!-- 비로그인 사용자 안내 -->
        <p class="text-red-500 text-sm mb-4">※ 댓글을 작성하려면 먼저 로그인해주세요.</p>
        {% endif %}

        <!-- 댓글 목록 -->
        <div class="space-y-2 text-sm">
            {% for comment in comments %}
            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                <strong class="text-gray-800">{{ comment.authorName }}</strong>
                <span class="text-gray-500 ml-2">{{ comment.createdAt.strftime('%Y-%m-%d %H:%M') }}</span>
                <p class="mt-1 text-gray-700">{{ comment.commentContent }}</p>
            </div>
            {% endfor %}
        </div>
  </div>

    <!-- 참여 / 취소 버튼 -->
    <div class="flex justify-end gap-4 mt-10">
        {% if is_participating %}
        <!-- 취소: DELETE 요청을 JS로 처리 -->
        <form id="cancel-form" action="/posts/{{ post._id }}/participate" method="POST"
        onsubmit="return cancelParticipation(event)">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <button type="submit" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">취소하기</button>
        </form>
        {% else %}
        <!-- 참여: POST -->
        <form action="/posts/{{ post._id }}/participate" method="POST">
            <input type="hidden" name="post_id" value="{{ post._id }}">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">참여하기</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
    async function cancelParticipation(event) {
        event.preventDefault();

        const form = event.target.closest("form");
        fetch(form.action, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(new FormData(form))
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                location.reload();
            }
        });

        return false;
    }
</script>
{% endblock %}